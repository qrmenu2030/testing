<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Меню с Корзиной</title>
<style>
body { font-family: Arial; background:#1a1a1a; color:white; padding:10px; margin:0; }
h1 { text-align:center; color:#ffcc00; margin-bottom:10px; }
#call-btn-header { display:block; background:#ff9900; color:white; text-align:center; padding:8px; border-radius:6px; text-decoration:none; margin:10px auto; width:220px; font-weight:bold; }
h2 { color:#ffcc00; margin-top:20px; }
ul { list-style:none; padding:0; }
li { display:flex; align-items:center; gap:10px; margin-bottom:10px; background:#2a2a2a; padding:8px; border-radius:6px; opacity:0; transform: translateY(20px); transition: all 0.3s ease; }
li.show { opacity:1; transform: translateY(0); }
img { width:50px; height:50px; border-radius:6px; object-fit:cover; }
.item-name { flex:1; }
.item-price { background:#ffcc00; color:#1a1a1a; padding:2px 6px; border-radius:8px; }
.add-btn, .remove-btn, .plus-btn, .minus-btn, #clear-cart { padding:4px 8px; border-radius:6px; text-decoration:none; font-size:0.8rem; cursor:pointer; }
.add-btn, .plus-btn { background:#25D366; color:white; border:none; font-weight:bold; font-size:1rem; width:32px; height:32px; line-height:24px; text-align:center; }
.remove-btn, .minus-btn, #clear-cart { background:#ff4d4d; color:white; border:none; cursor:pointer; border-radius:6px; padding:4px 8px; }
#cart { margin-top:20px; padding:10px; background:#2a2a2a; border-radius:8px; opacity:0; transition: opacity 0.5s; }
#cart.show { opacity:1; }
#cart-items li { justify-content: space-between; }
#send-order { display:block; margin-top:10px; padding:6px 12px; background:#25D366; color:white; text-align:center; border-radius:6px; text-decoration:none; font-weight:bold; }
#loading { text-align:center; margin:30px; }
.spinner {
  border: 6px solid #2a2a2a;
  border-top: 6px solid #ffcc00;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 50px auto;
}
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<h1>QR Меню Тест</h1>
<a id="call-btn-header" target="_blank">Вызвать официанта</a>
<div id="loading"><div class="spinner"></div></div>
<div id="menu-container" style="display:none;"></div>

<div id="cart" style="display:none;">
  <h2>Корзина</h2>
  <ul id="cart-items"></ul>
  <p>Сумма: <span id="cart-total">0</span> c</p>
  <a id="send-order" target="_blank">Отправить заказ в WhatsApp</a>
  <button id="clear-cart">Очистить корзину</button>
</div>

<script>
const sheetID = "1q6A9g5LvjZnlSl1I697UJt1kBiVPy2j4p7YwEQS3I3U"; 
const sheetName = "Лист1";
const query = encodeURIComponent("select A, B, C, D, E, F");
const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}&tq=${query}`;

let cart = [];

function gvizToJson(gvizText) {
    const jsonText = gvizText.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\)/)[1];
    return JSON.parse(jsonText);
}

function updateCartUI() {
    const cartContainer = document.getElementById("cart");
    const cartItems = document.getElementById("cart-items");
    const cartTotal = document.getElementById("cart-total");
    cartItems.innerHTML = "";
    let total = 0;

    cart.forEach((item, idx) => {
        total += item.price * item.quantity;
        const li = document.createElement("li");
        li.innerHTML = `
            <span>${item.name} – ${item.price} c</span>
            <div>
                <button class="minus-btn">➖</button>
                ${item.quantity}
                <button class="plus-btn">➕</button>
            </div>
        `;
        cartItems.appendChild(li);

        li.querySelector(".plus-btn").addEventListener("click", () => {
            item.quantity++;
            updateCartUI();
        });
        li.querySelector(".minus-btn").addEventListener("click", () => {
            item.quantity--;
            if(item.quantity <=0) cart.splice(idx,1);
            updateCartUI();
        });
    });

    cartTotal.textContent = total;
    cartContainer.style.display = cart.length > 0 ? "block" : "none";
    setTimeout(()=>cartContainer.classList.add('show'),50);

    const sendOrderBtn = document.getElementById("send-order");
    const itemsText = cart.map(i => `${i.quantity} x ${i.name}`).join(", ");
    sendOrderBtn.href = `https://wa.me/${cart[0]?.phoneOrder || ""}?text=Хочу заказать: ${encodeURIComponent(itemsText)}`;
}

// Добавление в корзину из меню
function addToCart(item) {
    const existing = cart.find(i => i.name === item.name);
    if (existing) existing.quantity++;
    else cart.push({...item, quantity: 1});
    updateCartUI();
}

// Очистка корзины
document.getElementById("clear-cart").addEventListener("click", () => {
    cart = [];
    updateCartUI();
});

// Загрузка меню из Google Sheets
fetch(url)
  .then(res => res.text())
  .then(rep => {
    const data = gvizToJson(rep);
    const container = document.getElementById("menu-container");
    const loading = document.getElementById("loading");
    const categories = {};
    let callPhone = "";

    data.table.rows.forEach(row => {
      const img = row.c[0]?.v;
      const name = row.c[1]?.v;
      const price = row.c[2]?.v;
      const category = row.c[3]?.v;
      const phoneOrder = row.c[4]?.v;
      const phoneCall = row.c[5]?.v;

      if (!callPhone && phoneCall) callPhone = phoneCall;
      if (!categories[category]) categories[category] = [];
      if (categories[category].length < 1) categories[category].push({img, name, price, phoneOrder});
    });

    const callBtnHeader = document.getElementById("call-btn-header");
    callBtnHeader.href = `https://wa.me/${callPhone}?text=Прошу вызвать официанта к столику №`;

    Object.keys(categories).forEach(cat => {
      const h2 = document.createElement("h2");
      h2.textContent = cat;
      container.appendChild(h2);

      const ul = document.createElement("ul");
      categories[cat].forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `
          <img src="${item.img}">
          <span class="item-name">${item.name}</span>
          <span class="item-price">${item.price} c</span>
          <button class="add-btn">➕</button>
        `;
        ul.appendChild(li);

        li.querySelector(".add-btn").addEventListener("click", () => {
          addToCart(item);
        });

        setTimeout(()=>li.classList.add('show'),50);
      });
      container.appendChild(ul);
    });

    loading.style.display = "none";
    container.style.display = "block";
  })
  .catch(err => {
    console.error("Ошибка при загрузке меню:", err);
    const container = document.getElementById("menu-container");
    container.innerHTML = "<p>Не удалось загрузить меню. Проверьте публикацию таблицы.</p>";
  });
</script>

</body>
</html>